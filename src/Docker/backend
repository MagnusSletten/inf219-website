# Use the official Python base image
FROM python:3.10-slim

# Set environment variable for Flask
ENV FLASK_APP=server.py
ENV FLASK_ENV=production

# Set the working directory
WORKDIR /app

# Install git to allow cloning the repository
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*

# Clone the repository to ensure the latest updates
RUN git clone https://github.com/MagnusSletten/inf219-website.git .
WORKDIR /app/inf219-website
RUN git pull

# Set the working directory
WORKDIR /app
# Install required packages including Git, curl, and GitHub CLI
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    git \
    curl \
    gnupg && \
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | gpg --dearmor -o /usr/share/keyrings/githubcli-archive-keyring.gpg && \
    echo "deb [signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list && \
    apt-get update && \
    apt-get install -y gh && \
    rm -rf /var/lib/apt/lists/*

# Install required Python packages
RUN pip install Flask Flask-Cors PyYAML

# Expose the port that Flask will run on
EXPOSE 5001

# Define the command to run the app
CMD ["python3", "src/server.py"]
